version: v1beta11

dependencies:
  - name: k3d
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/k3d
      branch: ingress-nginx

  - name: sealed-secrets
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/sealed-secrets
      branch: rework

commands:
  - name: init
    command: |-
      devspace run update
      devspace run k3d.init
      devspace run sealed-secrets.init

  - name: purge
    command: |-
      devspace run k3d.purge

  - name: activate
    command: |-
      devspace run k3d.activate

  - name: update
    command: |-
      devspace update dependencies

hooks:
  - name: install-cert-manager
    command: |-
      kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.0/cert-manager.yaml
      until kubectl wait --for=condition=available deployment.apps/cert-manager -n cert-manager --timeout=120s; do sleep 2; done
    os: darwin,linux
    events:
      - "before:deploy:vela-system"

deployments:
  - name: vela-system
    kubectl:
      kustomize: true
      kustomizeArgs: ["--enable-helm"]
      manifests:
        - ./dev/manifests/vela-system
    namespace: vela-system

  - name: vela-caps
    kubectl:
      kustomize: true
      manifests:
        - ./dev/manifests/vela-caps
    namespace: vela-system

profiles:
  - name: user
    activation:
      - env:
          ENV: "user"
    patches:
      - op: add
        path: "/deployments"
        value:
          name: cloud-app
          kubectl:
            kustomize: true
            manifests:
              - ./dev/manifests/applications/cloud-app
          namespace: cloud-app
      - op: add
        path: "/deployments"
        value:
          name: mixed-app
          kubectl:
            kustomize: true
            manifests:
              - ./dev/manifests/applications/mixed-app
          namespace: mixed-app
      - op: add
        path: "/deployments"
        value:
          name: mixed-app-network
          kubectl:
            kustomize: true
            manifests:
              - ./dev/manifests/applications/mixed-app-network
          namespace: mixed-app-network
